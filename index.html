<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Motion Study Atelier</title>
    
    <!-- Reggio Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    
    <!-- GIF Generation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gifshot/0.3.2/gifshot.min.js"></script>

    <style>
        /* --- Reggio "Lumi" Theme --- */
        :root {
            --bg-paper: #FDFBF7;
            --bg-canvas: #fff;
            --color-sage: #7C9082;
            --color-sage-light: #E8EDE9;
            --color-clay: #D4A373;
            --color-stone: #4A4A4A;
            --color-pebble: #A8B5BA;
            
            --glass-white: rgba(255, 255, 255, 0.9);
            --shadow-soft: 0 8px 24px rgba(124, 144, 130, 0.12);
            --border-light: rgba(0,0,0,0.08);
            
            --radius-lg: 24px;
            --radius-md: 16px;
            --radius-sm: 8px;
        }

        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            background-color: #2D2A26; 
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Lato', sans-serif;
            color: var(--color-stone);
            overflow: hidden;
            user-select: none;
        }

        /* The Main App Window */
        .atelier-container {
            width: 95%;
            height: 95%;
            max-width: 1100px;
            max-height: 850px;
            background-color: var(--bg-paper);
            background-image: 
                radial-gradient(var(--color-sage) 1px, transparent 1px);
            background-size: 40px 40px;
            border-radius: var(--radius-lg);
            box-shadow: 0 0 0 8px #3E3B36, 0 20px 60px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* --- Header --- */
        .atelier-header {
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.6);
            backdrop-filter: blur(5px);
            border-bottom: 1px solid var(--border-light);
            z-index: 20;
        }

        h1 {
            font-family: 'Playfair Display', serif;
            font-size: 22px;
            margin: 0;
            color: var(--color-stone);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .header-controls {
            display: flex;
            gap: 12px;
        }

        .btn-text {
            background: white;
            border: 1px solid var(--border-light);
            padding: 8px 16px;
            border-radius: 20px;
            font-family: 'Lato', sans-serif;
            font-weight: 600;
            color: var(--color-stone);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            font-size: 13px;
        }

        .btn-text:hover {
            border-color: var(--color-sage);
            color: var(--color-sage);
            transform: translateY(-1px);
        }
        
        .btn-danger:hover {
            border-color: #D4A373;
            color: #D4A373;
        }

        .btn-primary {
            background-color: var(--color-sage);
            color: white;
            border: none;
        }
        .btn-primary:hover {
            background-color: #6A7F70;
            color: white;
        }
        
        .btn-primary:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* --- Main Workspace --- */
        .workspace {
            flex: 1;
            display: flex;
            padding: 20px;
            gap: 20px;
            overflow: hidden;
            position: relative;
        }

        /* Toolbar (Left) */
        .tools-panel {
            width: 60px;
            background: var(--glass-white);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-soft);
            padding: 15px 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            z-index: 10;
        }

        .tool-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            border: 1px solid transparent;
            background: transparent;
            cursor: pointer;
            color: var(--color-stone);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .tool-btn:hover {
            background: #F0EEE6;
            transform: scale(1.05);
        }

        .tool-btn.active {
            background: var(--color-sage);
            color: white;
            box-shadow: 0 4px 10px rgba(124, 144, 130, 0.3);
        }
        
        .separator {
            width: 30px;
            height: 1px;
            background: #E0E0E0;
            margin: 4px 0;
        }

        /* Color Picker */
        .color-wrapper {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .color-wrapper:hover { transform: scale(1.1); }
        input[type="color"] {
            position: absolute;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            padding: 0; margin: 0;
            border: none;
            cursor: pointer;
        }

        /* Drawing Area (Center) */
        .canvas-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .canvas-wrapper {
            position: relative;
            background: white;
            box-shadow: 0 20px 50px rgba(0,0,0,0.1);
            width: auto;
            height: auto;
        }

        .layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            image-rendering: pixelated;
        }

        /* 1. Grid Background */
        #checkerboard-bg {
            z-index: 0;
            background-image: 
                linear-gradient(45deg, #eee 25%, transparent 25%), 
                linear-gradient(-45deg, #eee 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #eee 75%), 
                linear-gradient(-45deg, transparent 75%, #eee 75%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 0, 10px -10px, 0px 10px;
            opacity: 1;
        }

        /* 2. Onion Skin (Ghost) */
        #onion-skin-layer {
            z-index: 1;
            opacity: 0; /* Hidden by default */
            transition: opacity 0.2s;
            background-size: 100% 100%;
            background-repeat: no-repeat;
        }
        
        #onion-skin-layer.visible {
            opacity: 0.3; /* Ghost opacity */
        }

        /* 3. Main Drawing Canvas */
        canvas#mainCanvas {
            position: relative;
            z-index: 2;
            display: block;
            image-rendering: pixelated;
            background: transparent;
        }
        
        /* Grid Overlay (On Top) */
        .canvas-wrapper::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: 3;
            background-image: 
                linear-gradient(#ddd 1px, transparent 1px),
                linear-gradient(90deg, #ddd 1px, transparent 1px);
            background-size: 20px 20px; 
            opacity: 0.3;
        }

        /* --- Right Panel (Preview & Layers) --- */
        .preview-panel {
            width: 200px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel-card {
            background: var(--glass-white);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-soft);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .panel-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--color-pebble);
            margin-bottom: 10px;
            font-weight: 700;
            width: 100%;
            text-align: center;
        }

        .preview-box {
            width: 100%;
            aspect-ratio: 1/1;
            background: white;
            border: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            background-image: 
                linear-gradient(45deg, #eee 25%, transparent 25%), 
                linear-gradient(-45deg, #eee 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #eee 75%), 
                linear-gradient(-45deg, transparent 75%, #eee 75%);
            background-size: 10px 10px;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .preview-box canvas {
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
            background: none;
        }

        .playback-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            width: 100%;
            justify-content: center;
        }

        /* --- Timeline (Bottom) --- */
        .timeline {
            height: 110px;
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 15px;
            overflow-x: auto;
        }

        .timeline-label {
            width: 60px;
            text-align: right;
            font-size: 12px;
            font-weight: 700;
            color: var(--color-sage);
            line-height: 1.2;
        }

        .frames-container {
            display: flex;
            gap: 10px;
            padding: 10px 0;
        }

        .frame {
            width: 60px;
            height: 60px;
            background: white;
            border: 2px solid transparent;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .frame canvas {
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
            border-radius: 6px;
        }

        .frame:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
        }

        .frame.active {
            border-color: var(--color-sage);
            box-shadow: 0 0 0 3px rgba(124, 144, 130, 0.2);
        }

        .frame-number {
            position: absolute;
            bottom: 2px;
            right: 4px;
            font-size: 10px;
            color: var(--color-stone);
            background: rgba(255,255,255,0.8);
            padding: 1px 4px;
            border-radius: 4px;
        }

        .add-frame-btn {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            border: 2px dashed #ccc;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ccc;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .add-frame-btn:hover {
            border-color: var(--color-sage);
            color: var(--color-sage);
            background: var(--color-sage-light);
        }

    </style>
</head>
<body>

<div class="atelier-container">
    
    <!-- HEADER -->
    <header class="atelier-header">
        <h1>
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="2" y="2" width="20" height="20" rx="5" stroke="#7C9082"/>
                <path d="M8 12h8" stroke="#7C9082"/>
                <path d="M12 8v8" stroke="#7C9082"/>
            </svg>
            Motion Study
        </h1>
        <div class="header-controls">
            <button class="btn-text" id="resetBtn" title="Erase everything and start over">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>
                New Inquiry
            </button>
            <button class="btn-text btn-danger" id="clearBtn" title="Clear current moment">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                Clear Moment
            </button>
            <button class="btn-text btn-primary" id="downloadBtn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
                Capture GIF
            </button>
        </div>
    </header>

    <!-- WORKSPACE -->
    <div class="workspace">
        
        <!-- TOOLBAR -->
        <div class="tools-panel">
            <button class="tool-btn active" id="tool-pencil" title="Pencil">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
            </button>
            <button class="tool-btn" id="tool-eraser" title="Eraser">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 20H7L3 16C2 15 2 13 3 12L13 2L22 11L20 20Z"></path></svg>
            </button>
            <button class="tool-btn" id="tool-bucket" title="Fill">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 11l-8-8-9 9 8 8 5-5 9-9z"></path><path d="M22 22h-9"></path></svg>
            </button>
            <div class="separator"></div>
            <div class="color-wrapper" title="Color Palette">
                <input type="color" id="colorPicker" value="#4A4A4A">
            </div>
            <div class="separator"></div>
            <button class="tool-btn" id="onion-skin-toggle" title="Trace Memory (Onion Skin)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>
            </button>
        </div>

        <!-- CANVAS AREA -->
        <div class="canvas-area">
            <div class="canvas-wrapper">
                <div class="layer" id="checkerboard-bg"></div>
                <div class="layer" id="onion-skin-layer"></div>
                <canvas id="mainCanvas" width="32" height="32"></canvas>
            </div>
        </div>

        <!-- PREVIEW PANEL -->
        <div class="preview-panel">
            <div class="panel-card">
                <div class="panel-title">Observation</div>
                <div class="preview-box">
                    <canvas id="previewCanvas" width="32" height="32"></canvas>
                </div>
                <div class="playback-controls">
                    <button class="tool-btn" id="playBtn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                    </button>
                    <input type="range" id="fpsSlider" min="1" max="24" value="8" style="width: 60px">
                    <span id="fpsLabel" style="font-size: 10px; width: 30px">8fps</span>
                </div>
            </div>

            <div class="panel-card" style="flex:1; justify-content: flex-start;">
                <div class="panel-title">Guide</div>
                <p style="font-size: 13px; color: #888; text-align: center; line-height: 1.5;">
                    Add moments to the timeline below.<br><br>
                    Use the <strong>Trace Memory</strong> (Eye icon) to see the previous moment.
                </p>
            </div>
        </div>

    </div>

    <!-- TIMELINE -->
    <div class="timeline">
        <div class="timeline-label">Moments<br>captured</div>
        <div class="frames-container" id="framesContainer">
            <!-- Frames injected via JS -->
        </div>
        <button class="add-frame-btn" id="addFrameBtn" title="Add Moment">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        </button>
        <button class="add-frame-btn" id="copyFrameBtn" title="Duplicate Moment">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
        </button>
    </div>

</div>

<script>
    // --- Application State ---
    const CANVAS_SIZE = 32;
    const SCALE = 16; 
    const EXPORT_SCALE = 10; // Export GIF at 320x320
    
    let frames = []; 
    let currentFrameIndex = 0;
    let isPlaying = false;
    let playInterval = null;
    let onionSkin = false;
    
    let currentTool = 'pencil'; 
    let currentColor = '#4A4A4A';
    let isDrawing = false;

    // Elements
    const mainCanvas = document.getElementById('mainCanvas');
    const ctx = mainCanvas.getContext('2d', { willReadFrequently: true });
    const onionLayer = document.getElementById('onion-skin-layer');
    
    const previewCanvas = document.getElementById('previewCanvas');
    const pCtx = previewCanvas.getContext('2d');
    
    const framesContainer = document.getElementById('framesContainer');
    
    // CSS Scale Setup
    mainCanvas.style.width = (CANVAS_SIZE * SCALE) + 'px';
    mainCanvas.style.height = (CANVAS_SIZE * SCALE) + 'px';
    
    // Initialize
    function init() {
        frames = [];
        currentFrameIndex = 0;
        addFrame();
        updateUI();
        setupEvents();
    }

    // --- Core Functions ---

    function createBlankImageData() {
        return ctx.createImageData(CANVAS_SIZE, CANVAS_SIZE);
    }

    function addFrame(copyFromIndex = null) {
        let newData;
        if (copyFromIndex !== null && frames[copyFromIndex]) {
            newData = new ImageData(
                new Uint8ClampedArray(frames[copyFromIndex].data),
                CANVAS_SIZE,
                CANVAS_SIZE
            );
        } else {
            newData = createBlankImageData();
        }
        
        frames.push(newData);
        currentFrameIndex = frames.length - 1;
        loadFrame(currentFrameIndex);
        renderTimeline();
    }

    function loadFrame(index) {
        currentFrameIndex = index;
        ctx.putImageData(frames[index], 0, 0);
        updateOnionSkin();
        updateTimelineUI();
        // Update preview immediately
        pCtx.clearRect(0,0,CANVAS_SIZE, CANVAS_SIZE);
        pCtx.putImageData(frames[index], 0, 0);
    }

    function saveCurrentFrame() {
        frames[currentFrameIndex] = ctx.getImageData(0, 0, CANVAS_SIZE, CANVAS_SIZE);
        updateFrameThumbnail(currentFrameIndex);
    }

    // --- Rendering & Onion Skin ---

    function updateOnionSkin() {
        if (onionSkin && currentFrameIndex > 0) {
            const temp = document.createElement('canvas');
            temp.width = CANVAS_SIZE;
            temp.height = CANVAS_SIZE;
            const tCtx = temp.getContext('2d');
            tCtx.putImageData(frames[currentFrameIndex - 1], 0, 0);
            
            const url = temp.toDataURL();
            onionLayer.style.backgroundImage = `url(${url})`;
            onionLayer.classList.add('visible');
        } else {
            onionLayer.style.backgroundImage = 'none';
            onionLayer.classList.remove('visible');
        }
    }

    // --- Drawing Logic ---

    function getPixelCoords(e) {
        const rect = mainCanvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        
        const x = Math.floor((clientX - rect.left) / SCALE);
        const y = Math.floor((clientY - rect.top) / SCALE);
        return { x, y };
    }

    function drawPixel(x, y) {
        if (x < 0 || x >= CANVAS_SIZE || y < 0 || y >= CANVAS_SIZE) return;
        
        const r = parseInt(currentColor.slice(1, 3), 16);
        const g = parseInt(currentColor.slice(3, 5), 16);
        const b = parseInt(currentColor.slice(5, 7), 16);
        
        const imgData = ctx.getImageData(0, 0, CANVAS_SIZE, CANVAS_SIZE);
        const index = (y * CANVAS_SIZE + x) * 4;
        
        if (currentTool === 'eraser') {
            imgData.data[index + 3] = 0; 
        } else {
            imgData.data[index] = r;
            imgData.data[index + 1] = g;
            imgData.data[index + 2] = b;
            imgData.data[index + 3] = 255;
        }
        
        ctx.putImageData(imgData, 0, 0);
        saveCurrentFrame(); 
    }

    function floodFill(startX, startY) {
        const imgData = ctx.getImageData(0, 0, CANVAS_SIZE, CANVAS_SIZE);
        const data = imgData.data;
        
        const startIdx = (startY * CANVAS_SIZE + startX) * 4;
        const startR = data[startIdx];
        const startG = data[startIdx+1];
        const startB = data[startIdx+2];
        const startA = data[startIdx+3];
        
        const targetR = parseInt(currentColor.slice(1, 3), 16);
        const targetG = parseInt(currentColor.slice(3, 5), 16);
        const targetB = parseInt(currentColor.slice(5, 7), 16);
        
        if (startR === targetR && startG === targetG && startB === targetB && startA === 255) return;
        
        const queue = [[startX, startY]];
        
        while(queue.length > 0) {
            const [x, y] = queue.pop();
            const idx = (y * CANVAS_SIZE + x) * 4;
            
            if (x < 0 || x >= CANVAS_SIZE || y < 0 || y >= CANVAS_SIZE) continue;
            
            if (data[idx] === startR && data[idx+1] === startG && data[idx+2] === startB && data[idx+3] === startA) {
                data[idx] = targetR;
                data[idx+1] = targetG;
                data[idx+2] = targetB;
                data[idx+3] = 255; 
                
                queue.push([x+1, y]);
                queue.push([x-1, y]);
                queue.push([x, y+1]);
                queue.push([x, y-1]);
            }
        }
        ctx.putImageData(imgData, 0, 0);
        saveCurrentFrame();
    }

    // --- Timeline UI ---

    function renderTimeline() {
        framesContainer.innerHTML = '';
        frames.forEach((frameData, index) => {
            const el = document.createElement('div');
            el.className = `frame ${index === currentFrameIndex ? 'active' : ''}`;
            el.onclick = () => loadFrame(index);
            
            const thumb = document.createElement('canvas');
            thumb.width = CANVAS_SIZE;
            thumb.height = CANVAS_SIZE;
            thumb.getContext('2d').putImageData(frameData, 0, 0);
            
            const num = document.createElement('span');
            num.className = 'frame-number';
            num.innerText = index + 1;
            
            el.appendChild(thumb);
            el.appendChild(num);
            framesContainer.appendChild(el);
        });
    }

    function updateTimelineUI() {
        const els = framesContainer.children;
        for (let i = 0; i < els.length; i++) {
            els[i].classList.toggle('active', i === currentFrameIndex);
        }
    }

    function updateFrameThumbnail(index) {
        if (!framesContainer.children[index]) return;
        const canvas = framesContainer.children[index].querySelector('canvas');
        canvas.getContext('2d').putImageData(frames[index], 0, 0);
        
        if(!isPlaying) {
            pCtx.clearRect(0,0,CANVAS_SIZE, CANVAS_SIZE);
            pCtx.drawImage(canvas, 0, 0);
        }
    }

    // --- Animation Logic ---

    function togglePlay() {
        isPlaying = !isPlaying;
        const btn = document.getElementById('playBtn');
        
        if (isPlaying) {
            btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>`;
            
            let frameIdx = currentFrameIndex;
            const fps = document.getElementById('fpsSlider').value;
            const interval = 1000 / fps;
            
            playInterval = setInterval(() => {
                pCtx.clearRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);
                pCtx.putImageData(frames[frameIdx], 0, 0);
                frameIdx = (frameIdx + 1) % frames.length;
            }, interval);
            
        } else {
            btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>`; 
            clearInterval(playInterval);
            pCtx.putImageData(frames[currentFrameIndex], 0, 0);
        }
    }

    // --- Export Logic (UPDATED: "Save As" / Show Picker) ---

    function downloadGIF() {
        const btn = document.getElementById('downloadBtn');
        const origText = btn.innerHTML;
        btn.innerHTML = 'Processing...';
        btn.disabled = true;

        // 1. Prepare images (scale up for visibility)
        const images = frames.map(frameData => {
            const tCan = document.createElement('canvas');
            tCan.width = CANVAS_SIZE * EXPORT_SCALE;
            tCan.height = CANVAS_SIZE * EXPORT_SCALE;
            const tCtx = tCan.getContext('2d');
            
            // Draw small data to temp small canvas first
            const sCan = document.createElement('canvas');
            sCan.width = CANVAS_SIZE;
            sCan.height = CANVAS_SIZE;
            sCan.getContext('2d').putImageData(frameData, 0, 0);

            // Draw scaled up with nearest neighbor
            tCtx.imageSmoothingEnabled = false;
            tCtx.drawImage(sCan, 0, 0, tCan.width, tCan.height);
            
            return tCan.toDataURL();
        });

        const fps = document.getElementById('fpsSlider').value;

        // 2. Generate GIF
        gifshot.createGIF({
            images: images,
            gifWidth: CANVAS_SIZE * EXPORT_SCALE,
            gifHeight: CANVAS_SIZE * EXPORT_SCALE,
            interval: 1 / fps,
            numFrames: images.length,
            sampleInterval: 10, // Quality trade-off
        }, async function(obj) {
            if(!obj.error) {
                // --- NEW SAVING LOGIC ---
                // Try modern "Save As" picker first (Works great on Chromebooks)
                if (window.showSaveFilePicker) {
                    try {
                        // Convert base64 to Blob
                        const blob = await (await fetch(obj.image)).blob();
                        
                        const handle = await window.showSaveFilePicker({
                            suggestedName: 'motion-study.gif',
                            types: [{
                                description: 'GIF File',
                                accept: {'image/gif': ['.gif']},
                            }],
                        });
                        const writable = await handle.createWritable();
                        await writable.write(blob);
                        await writable.close();
                    } catch (err) {
                        // User cancelled or error, fallback to download
                        console.log("Save Picker cancelled or failed, falling back.");
                        fallbackDownload(obj.image);
                    }
                } else {
                    // Fallback for older browsers
                    fallbackDownload(obj.image);
                }
            } else {
                alert("Could not generate GIF.");
            }
            btn.innerHTML = origText;
            btn.disabled = false;
        });
    }

    function fallbackDownload(dataUrl) {
        const link = document.createElement('a');
        link.download = 'motion-study.gif';
        link.href = dataUrl;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // --- Events Setup ---

    function setupEvents() {
        document.getElementById('tool-pencil').onclick = () => setTool('pencil');
        document.getElementById('tool-eraser').onclick = () => setTool('eraser');
        document.getElementById('tool-bucket').onclick = () => setTool('bucket');
        
        document.getElementById('colorPicker').oninput = (e) => {
            currentColor = e.target.value;
            setTool('pencil');
        };

        const startDraw = (e) => {
            isDrawing = true;
            const {x, y} = getPixelCoords(e);
            if (currentTool === 'bucket') {
                floodFill(x, y);
                isDrawing = false; 
            } else {
                drawPixel(x, y);
            }
        };
        
        const moveDraw = (e) => {
            if (!isDrawing) return;
            e.preventDefault(); 
            const {x, y} = getPixelCoords(e);
            drawPixel(x, y);
        };
        
        const endDraw = () => { isDrawing = false; };

        mainCanvas.addEventListener('mousedown', startDraw);
        window.addEventListener('mousemove', moveDraw);
        window.addEventListener('mouseup', endDraw);
        
        mainCanvas.addEventListener('touchstart', startDraw, {passive: false});
        window.addEventListener('touchmove', moveDraw, {passive: false});
        window.addEventListener('touchend', endDraw);

        document.getElementById('addFrameBtn').onclick = () => addFrame();
        document.getElementById('copyFrameBtn').onclick = () => addFrame(currentFrameIndex);
        
        document.getElementById('playBtn').onclick = togglePlay;
        
        document.getElementById('fpsSlider').oninput = (e) => {
            document.getElementById('fpsLabel').innerText = e.target.value + 'fps';
            if(isPlaying) { togglePlay(); togglePlay(); } 
        };
        
        document.getElementById('onion-skin-toggle').onclick = (e) => {
            onionSkin = !onionSkin;
            e.currentTarget.classList.toggle('active');
            updateOnionSkin();
        };

        document.getElementById('clearBtn').onclick = () => {
            if(confirm("Clear this moment?")) {
                ctx.clearRect(0,0,CANVAS_SIZE, CANVAS_SIZE);
                saveCurrentFrame();
            }
        };

        // NEW: Reset All
        document.getElementById('resetBtn').onclick = () => {
            if(confirm("Start a new inquiry? This will erase all moments.")) {
                if(isPlaying) togglePlay();
                init(); // Re-runs init, clearing frames array
                renderTimeline();
                loadFrame(0);
            }
        };

        document.getElementById('downloadBtn').onclick = downloadGIF;
    }

    function setTool(tool) {
        currentTool = tool;
        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
        if(tool === 'pencil') document.getElementById('tool-pencil').classList.add('active');
        if(tool === 'eraser') document.getElementById('tool-eraser').classList.add('active');
        if(tool === 'bucket') document.getElementById('tool-bucket').classList.add('active');
    }
    
    function updateUI() {
        // Refresh things
    }

    // Start
    init();

</script>
</body>
</html>
